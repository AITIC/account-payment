<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <template id="report_payment_group_document">
        <t t-call="web.external_layout">
            <t t-set="o" t-value="o.with_context(lang=lang)" />
            <t t-set="report_date" t-value="o.payment_date"/>
            <t t-set="report_number" t-value="o.name"/>
            <t t-set="report_name" t-value="o.partner_type == 'supplier' and 'Orden de pago' or 'Recibo'"/>
            <t t-set="header_address" t-value="o.company_id.partner_id"/>

            <t t-set="custom_footer">
                <div class="row">
                    <div name="footer_left_column" class="col-8">
                        Observaciones: <span t-field="o.notes"/>
                    </div>
                    <div name="footer_right_column" class="col-4">
                        <span class="text-center">Firma y Aclaración</span>
                        <div class="text-right" name="pager" t-if="report_type == 'pdf'">
                            Page: <span class="page"/> / <span class="topage"/>
                        </div>
                    </div>
                </div>
            </t>
            <div class="page">
                <div id="informations" class="row mt8 mb8">
                    <div class="col-6">

                        <!-- IDENTIFICACION (ADQUIRIENTE-LOCATARIO-PRESTARIO) -->

                        <!-- (14) Apellido uy Nombre: Denominicacion o Razon Soclial -->
                        <strong><span t-raw="o.partner_type == 'supplier' and 'Proveedor: ' or 'Cliente: '"/></strong><span t-field="o.partner_id.name"/>

                        <!-- (15) Domicilio Comercial -->
                        <br/>
                        <span t-esc="o.partner_id" t-options='{"widget": "contact", "fields": ["address"], "no_marker": True, "no_tag_br": True}'/>

                        <!-- (17) VAT -->
                        <strong>VAT: </strong><span t-field="o.partner_id.vat"/>

                    </div>
                    <div class="col-6">
                        <t t-set="payment_name" t-value="o.partner_type == 'customer' and 'Recibo N°'
                                            or 'Orden de pago'"/>
                        <strong><span t-esc="'%s: ' % (payment_name,)"/></strong>
                        <span t-esc="'%s' % (o.display_name,)"/>
                    </div>
                </div>
                <br/>
                <table class="table table-sm o_main_table" name="payments_table">
                    <thead>
                        <tr>
                            <th><span>Pagos</span></th>
                            <th class="text-right"><span>Importe</span></th>
                        </tr>
                    </thead>
                    <tbody>
                        <t t-foreach="o.payment_ids" t-as="line">
                            <tr>
                                <td>
                                    <span t-field="line.journal_id.name"/>
                                </td>
                                <td class="text-right o_price_total">
                                    <span class="text-nowrap" t-field="line.l10n_ar_amount_company_currency_signed"/>
                                </td>
                            </tr>
                        </t>
                    </tbody>
                    <tfoot>
                        <tr>
                            <td><strong><span>Total Pagado</span></strong></td>
                            <td class="text-right">
                                <strong><span class="text-nowrap" t-field="o.payments_amount"/></strong>
                            </td>
                        </tr>
                    </tfoot>
                </table>
                <br/>
                <table class="table table-sm o_main_table" name="matching_table">
                    <thead>
                        <tr>
                            <th><span>Comprobantes Imputados</span></th>
                            <th class="text-center"><span>Fecha Venc.</span></th>
                            <th class="text-right"><span>Importe Original</span></th>
                            <th class="text-right"><span>Importe Imputado</span></th>
                        </tr>
                    </thead>
                    <tbody>
                        <t t-foreach="o.with_context(payment_group_id=o.id).matched_move_line_ids" t-as="line">
                            <tr>
                                <td><span t-field='line.move_id.display_name'/></td>
                                <td class="text-center">
                                    <span class="text-nowrap" t-field="line.date_maturity"/>
                                </td>
                                <td class="text-right o_price_total">
                                    <span class="text-nowrap" t-raw="(o.partner_type == 'supplier' and -1.0 or 1.0) * line.balance" t-options='{"widget": "monetary", "display_currency": o.currency_id}'/>
                                </td>
                                <td class="text-right o_price_total">
                                    <span class="text-nowrap" t-raw="(o.partner_type == 'supplier' and -1.0 or 1.0) * line.payment_group_matched_amount" t-options='{"widget": "monetary", "display_currency": o.currency_id}'/>
                                </td>
                            </tr>
                        </t>
                        <tr t-if="o.unmatched_amount">
                            <td>A cuenta</td>
                            <td class="text-center"/>
                            <td class="text-right o_price_total"/>
                            <td class="text-right o_price_total">
                                <span class="text-nowrap" t-field="o.unmatched_amount"/>
                            </td>
                        </tr>
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="3"><strong><span>Total Imputado</span></strong></td>
                            <td class="text-right">
                                <strong><span class="text-nowrap" t-raw="o.unmatched_amount + o.matched_amount" t-options='{"widget": "monetary", "display_currency": o.currency_id}'/></strong>
                            </td>
                        </tr>
                    </tfoot>
                </table>
                <br/>
                <table class="table table-sm o_main_table" name="open_table" t-if="o.partner_type=='customer'" groups="l10n_ar_ux.group_include_pending_receivable_documents">
                    <thead>
                        <tr>
                            <th><span>Comprobantes Pendientes al</span><span t-raw="datetime.datetime.today()" t-options='{"widget": "date"}'/></th>
                            <th class="text-center"><span>Fecha Venc.</span></th>
                            <th class="text-right"><span>Importe Original</span></th>
                            <th class="text-right"><span>Saldo</span></th>
                        </tr>
                    </thead>
                    <tbody>
                        <t t-foreach="o.env['account.move.line'].search([('partner_id', '=', o.partner_id.commercial_partner_id.id), ('account_id.internal_type', '=', o.partner_type=='customer' and 'receivable' or 'payable'), ('reconciled', '=', False), ('account_id.deprecated', '=', False), ('move_id.state', '=', 'posted'), ('company_id', '=', o.company_id.id)])" t-as="line">
                            <tr>
                                <td><span t-field='line.move_id.display_name'/></td>
                                <td class="text-center">
                                    <span class="text-nowrap" t-field="line.date_maturity"/>
                                </td>
                                <td class="text-right o_price_total">
                                    <span class="text-nowrap" t-field="line.balance"/>
                                </td>
                                <td class="text-right o_price_total">
                                    <span class="text-nowrap" t-field="line.amount_residual"/>
                                </td>
                            </tr>
                        </t>
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="3"><strong><span>Total Pendiente</span></strong></td>
                            <td class="text-right">
                                <strong><span class="text-nowrap" t-raw="sum(o.env['account.move.line'].search([('partner_id', '=', o.partner_id.commercial_partner_id.id), ('account_id.internal_type', '=', o.partner_type=='customer' and 'receivable' or 'payable'), ('reconciled', '=', False), ('account_id.deprecated', '=', False), ('move_id.state', '=', 'posted'), ('company_id', '=', o.company_id.id)]).mapped('amount_residual'))" t-options='{"widget": "monetary", "display_currency": o.currency_id}'/></strong>
                            </td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </t>
    </template>

    <template id="report_payment_group">
        <t t-call="web.html_container">
            <t t-foreach="docs" t-as="o">
                <t t-set="lang" t-value="o.partner_id.lang"/>
                <t t-call="account_payment_group.report_payment_group_document" t-lang="lang"/>
            </t>
        </t>
    </template>

    <record id="action_report_payment_group" model="ir.actions.report">
        <field name="name">Receipt / Payment Order</field>
        <field name="model">account.payment.group</field>
        <field name="binding_model_id" ref="model_account_payment_group"/>
        <field name="report_type">qweb-pdf</field>
        <field name="print_report_name">(object.partner_type == 'supplier' and 'Orden de pago' or 'Recibo') + ' ' + (object.document_number or 'Borrador')</field>
        <field name="report_name">account_payment_group.report_payment_group</field>
        <field name="report_file">account_payment_group.report_payment_group</field>
    </record>

</odoo>
